---
title: 設計目標
icon: goal
order: 2
---

[Valine](https://valine.js.org) は洗練されたスタイル、シンプルな操作、効率的なデプロイが特徴のコメントシステムです。初めて触れたとき、その洗練されたスタイルとサーバーレスの特性に惹かれました。バックエンドサービスが不要で、フロントエンドが LeanCloud ストレージサービスと直接やり取りするのは本当に素晴らしいと思いました。しかし、深く理解するにつれて、いくつかの問題点に気づきました。

## Valine の問題点

### オープンソースでない

作者はバージョン `1.4.0` 以降、GitHub リポジトリにコンパイル済みのファイルのみをプッシュするようになり、ソースコードの更新が止まりました。おそらく作者はオープンソースに対して心を閉ざしてしまったのでしょう。プロジェクトに機能を追加・修正したい私のようなユーザーにとっては、この問題は少々不便です。

### XSS

非常に初期のバージョンから、ユーザーたちは Valine の XSS 問題を報告しており、コミュニティもさまざまな方法でこれらの問題を修正しようとしてきました。認証コードの追加やフロントエンドでの XSS フィルタリングなどの方法が試みられました。しかし、作者は後にフロントエンドの検証はすべて「紳士」しか防げないと気づき、認証コードなどの制限を削除しました。

現在、フロントエンドでコメントを投稿する際、Markdown は HTML に変換され、LeanCloud に送信される前にフロントエンドで XSS フィルター関数が実行されます。LeanCloud からデータを取得した後は、そのまま DOM に挿入されます。明らかにこのプロセスには問題があります。HTML を直接送信して取得後にそのまま表示する限り、XSS を根本的に根絶することはできません。

::: note 根本的な解決策

保存型 XSS 攻撃に対しては、HTML をエスケープすることで永続的に解決できます。かつての BBCode のように、データベースには Markdown のコンテンツのみを送信します。フロントエンドはコンテンツを読み込み、Markdown 変換後に表示する前にすべての HTML をエンコードします。

```js
function encodeForHTML(str) {
  return ('' + str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
}
```

Valine はサーバーレスシステムであるため、攻撃者はストレージ段階に直接アクセスできます。データ保存前のすべての予防措置は無効であり、表示処理の時点でのみ対処できます。エスケープ後はすべての HTML が解析できなくなるため、変換された HTML が挿入される余地がなくなります。

Valine はもはやオープンソースではないため、プルリクエストを送ることができません。

:::

上記の方法はユーザーを Markdown の範囲内に完全に制限してしまうため、Waline は `0.15.0` 以降、クライアント側に `DOMPurify` を追加して XSS を防止しています。通常の XSS 除去に加えて：

- `<form>` と `<input>` が無効化されます
- スタイルのインジェクションが無効化されます
- メディアの自動再生が無効化されます
- すべての外部リンクは処理され、`rel` が `noopener noreferrer` の新しいウィンドウで開かれます

### プライバシーの漏洩

ストレージへの直接アクセスだけでなく、攻撃者はあらゆるデータを直接読み取ることもできます。データベースのフィールドが誰でも読み取り可能なパーミッションに設定されている場合、そのフィールドの内容は攻撃者に対して完全に透明です。

コメントデータの中で、IP とメールボックスの 2 つのフィールドにはユーザーの機密データが含まれています。Deng 氏はこの問題を批判する記事を特別に書きました：[Please stop using the Valine.js comment system immediately unless it fixes the user privacy leak](https://ttys3.net/post/hugo/please-stop-using-valine-js-comment-system-until-it-fixed-the-privacy-leaking-problem/)。また、[JueJin](https://juejin.cn) コミュニティが初期に LeanCloud を使用していた際にも、[ユーザーの携帯番号が流出した](https://m.weibo.cn/detail/4568007327622344?cid=4568044392682999) セキュリティ問題が露呈しました。

この問題を回避するため、Valine の作者はユーザー IP の記録を許可するかどうかを設定する `recordIP` 設定を追加しました。サーバーがないため、値を保存しないことでしか解決できません。

ただし、このオプションにはまだ問題があります：IP を記録するかどうかはサイト管理者の設定に基づいており、コメント投稿者は自分のプライバシーを管理する権限がありません。

メールアドレスの漏洩もまた主要なプライバシー問題です。フロントエンドでユーザーのメールのmd5を計算してGravatarアバターを取得するのは完全に実現可能です。しかし、コメントへの返信時にメール通知を送信する場合、ユーザーのメールアドレスの元の値を保存することは避けられません。理論的にはRSA暗号化でこの問題を解決できます。秘密鍵はLeanCloudの環境変数に保存し、クライアントはメールのmd5と公開鍵で暗号化されたメールの両方を報告します。LeanCloudがメール通知を送信する際、クラウド関数で環境内の秘密鍵を読み込み、復号化してユーザーのメールアドレスを取得します。しかし、フロントエンドのRSA暗号化ライブラリのサイズとパフォーマンスを考えると、現実的ではありません。サーバーレイヤーを追加してサーバーサイドで機密情報をフィルタリングする方が、間違いなくより良い実践です。

### 閲覧統計の改ざん

Valine 1.2.0 では記事の閲覧統計機能が追加されました。ユーザーがページを訪問すると、バックグラウンドのカウンターテーブルに URL に基づいて訪問回数が記録されます。ページにアクセスするたびにデータを更新する必要があるため、後続のフィールド更新を実行できるよう、パーミッションを書き込み可能に設定する必要があります。これにより問題が生じます。実際には、データを任意の値に更新できてしまいます。興味があれば、<https://valine.js.org/visitor.html> の公式サイトを開いてコンソールに入り、以下のコードを入力してみてください。試した後は数値を元に戻すことを忘れずに～

```js
const counter = new AV.Query('Counter');
const resp = await counter.equalTo('url', '/visitor.html').find();
resp[0].set('time', -100000).save();
location.reload();
```

幸い、`time` フィールドの値は Number 型なので、他の値を挿入することはできません。`time` フィールドが文字列型であれば、XSS 脆弱性になる可能性があります。この問題の解決策として、累積保存方式を使用しないことが考えられます。各訪問について読み取り専用のアクセス記録を保存するように変更し、読み取り時に `count()` メソッドで統計を取ります。これにより、すべてのデータが読み取り専用となり、改ざんの問題が解決されます。ただし、この解決策にも問題があります：データ量が比較的多い場合、クエリに一定の負荷がかかります。

元のデータ構造を維持したままにする場合、変更権限を分離するためにサーバーレイヤーを追加するしかありません。

## Waline の誕生

上記の理由から、Waline が誕生しました。Waline の当初の目標は Valine にバックエンドを追加するだけでしたが、Valine がオープンソースでないため、フロントエンドで実装するしかありませんでした。もちろん、Valine との設定の互換性を保つため、フロントエンドのコードやロジックの多くは Valine を参考にしています。プロジェクト名においても Valine から派生させることで、このプロジェクトが Valine の派生であることを皆さんに理解していただけるようにしました。

上述のセキュリティ問題を解決する以外にも、サーバーサイドの追加によって、これまでサーバーがないことで制限されていた多くの機能が実現できるようになりました。メール通知やスパムコメントフィルタリングなどがその例です。
